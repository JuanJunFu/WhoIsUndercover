<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>誰是臥底 - 玩家介面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 40px 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translate(-30%, -30%); }
            50% { transform: translate(30%, 30%); }
        }

        .title {
            font-size: 28px;
            color: #fff;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        /* 輸入區域 */
        .input-section {
            position: relative;
            z-index: 1;
        }

        .player-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 18px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            outline: none;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .player-input::placeholder {
            color: rgba(255,255,255,0.4);
        }

        .player-input:focus {
            border-color: #ffd700;
            background: rgba(255,255,255,0.15);
        }

        .join-btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
        }

        .join-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(255, 215, 0, 0.5);
        }

        .join-btn:active {
            transform: translateY(0);
        }

        .join-btn:disabled {
            background: #666;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* 等待畫面 */
        .waiting-section {
            display: none;
            position: relative;
            z-index: 1;
        }

        .player-name-display {
            font-size: 24px;
            color: #ffd700;
            margin-bottom: 20px;
        }

        .waiting-text {
            color: rgba(255,255,255,0.8);
            font-size: 16px;
            margin-bottom: 20px;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 角色揭曉 */
        .role-section {
            display: none;
            position: relative;
            z-index: 1;
        }

        .role-badge {
            display: inline-block;
            padding: 10px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 30px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .role-civilian {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: #fff;
        }

        .role-undercover {
            background: linear-gradient(135deg, #f44336, #c62828);
            color: #fff;
        }

        .role-blank {
            background: linear-gradient(135deg, #9C27B0, #6A1B9A);
            color: #fff;
        }

        .word-container {
            margin: 30px 0;
        }

        .word-label {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 10px;
        }

        .word-display {
            font-size: 48px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 4px 20px rgba(255,215,0,0.5);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .word-hidden {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tap-hint {
            font-size: 14px;
            color: rgba(255,255,255,0.5);
            margin-top: 20px;
        }

        .reveal-btn {
            padding: 12px 40px;
            font-size: 16px;
            border: 2px solid #ffd700;
            border-radius: 50px;
            background: transparent;
            color: #ffd700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .reveal-btn:hover {
            background: #ffd700;
            color: #1a1a2e;
        }

        /* 提示區 */
        .tips {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .tips-title {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 10px;
        }

        .tips-content {
            font-size: 13px;
            color: rgba(255,255,255,0.4);
            line-height: 1.6;
        }

        /* 錯誤訊息 */
        .error-message {
            display: none;
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #ff8a80;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* 遊戲結束 */
        .game-over-section {
            display: none;
            position: relative;
            z-index: 1;
        }

        .game-result {
            font-size: 32px;
            margin-bottom: 20px;
        }

        .result-win {
            color: #4CAF50;
        }

        .result-lose {
            color: #f44336;
        }

        .final-role {
            font-size: 18px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 30px;
        }

        /* 背景動畫 */
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            animation: float 15s infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* 震動效果 */
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
    </style>
</head>
<body>
    <div class="bg-particles" id="particles"></div>

    <div class="container">
        <div class="card" id="mainCard">
            <!-- 加入遊戲 -->
            <div class="input-section" id="inputSection">
                <h1 class="title">誰是臥底</h1>
                <p class="subtitle">結業回憶特別版</p>

                <div class="error-message" id="errorMsg"></div>

                <input type="text" class="player-input" id="playerName"
                       placeholder="請輸入你的暱稱" maxlength="10" autocomplete="off">
                <button class="join-btn" id="joinBtn" onclick="joinGame()">加入遊戲</button>
            </div>

            <!-- 等待開始 -->
            <div class="waiting-section" id="waitingSection">
                <h1 class="title">等待遊戲開始</h1>
                <p class="player-name-display" id="displayName"></p>
                <p class="waiting-text">請看主螢幕，等待主持人開始遊戲...</p>
                <div class="loader"></div>
            </div>

            <!-- 角色揭曉 -->
            <div class="role-section" id="roleSection">
                <h1 class="title">你的身份</h1>

                <div class="role-badge" id="roleBadge"></div>

                <div class="word-container">
                    <p class="word-label">你的詞語是：</p>
                    <div class="word-display" id="wordDisplay">
                        <div class="word-hidden">
                            <span>? ? ?</span>
                        </div>
                    </div>
                </div>

                <button class="reveal-btn" id="revealBtn" onclick="toggleWord()">點擊查看詞語</button>
                <p class="tap-hint">小心別被別人看到！</p>

                <div class="tips">
                    <p class="tips-title">遊戲提示</p>
                    <p class="tips-content" id="tipsContent"></p>
                </div>
            </div>

            <!-- 遊戲結束 -->
            <div class="game-over-section" id="gameOverSection">
                <h1 class="title">遊戲結束</h1>
                <p class="game-result" id="gameResult"></p>
                <p class="final-role" id="finalRole"></p>
                <button class="join-btn" onclick="location.reload()">再玩一局</button>
            </div>
        </div>
    </div>

    <script>
        // n8n Webhook URL
        const N8N_WEBHOOK_URL = 'https://n8n.forestrealty.org/webhook/fa0ce324-994a-4289-8ed8-d802f5cc39c1';

        // 狀態
        let sessionId = null;
        let playerId = null;
        let playerName = '';
        let myRole = null;
        let myWord = null;
        let wordVisible = false;
        let checkInterval = null;

        // 發送資料到 n8n
        async function sendToWebhook(eventType, data) {
            try {
                const payload = {
                    event_type: eventType,
                    session_id: sessionId,
                    player_id: playerId,
                    player_name: playerName,
                    role: myRole || '',
                    word: myWord || '',
                    join_time: new Date().toISOString(),
                    ...data
                };

                await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'no-cors'
                });
                console.log('Data sent to n8n:', eventType);
            } catch (error) {
                console.error('Failed to send to n8n:', error);
            }
        }

        // 初始化
        function init() {
            // 建立背景粒子
            createParticles();

            // 從 URL 取得 session ID
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('session');

            if (!sessionId) {
                showError('無效的遊戲連結，請重新掃描 QR Code');
                document.getElementById('joinBtn').disabled = true;
                return;
            }

            // 檢查是否已經加入
            const savedData = localStorage.getItem(`player_${sessionId}`);
            if (savedData) {
                const data = JSON.parse(savedData);
                playerId = data.playerId;
                playerName = data.playerName;

                // 檢查遊戲狀態
                checkGameState();
            }

            // 按 Enter 加入
            document.getElementById('playerName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinGame();
            });
        }

        // 建立背景粒子
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (10 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }

        // 顯示錯誤
        function showError(msg) {
            const errorEl = document.getElementById('errorMsg');
            errorEl.textContent = msg;
            errorEl.style.display = 'block';
            document.getElementById('mainCard').classList.add('shake');
            setTimeout(() => {
                document.getElementById('mainCard').classList.remove('shake');
            }, 500);
        }

        // 隱藏錯誤
        function hideError() {
            document.getElementById('errorMsg').style.display = 'none';
        }

        // 加入遊戲
        function joinGame() {
            hideError();

            const nameInput = document.getElementById('playerName');
            playerName = nameInput.value.trim();

            if (!playerName) {
                showError('請輸入你的暱稱');
                return;
            }

            if (playerName.length > 10) {
                showError('暱稱最多 10 個字');
                return;
            }

            // 檢查遊戲是否存在
            const gameData = localStorage.getItem(`game_${sessionId}`);
            if (!gameData) {
                showError('遊戲不存在或已結束，請聯繫主持人');
                return;
            }

            const game = JSON.parse(gameData);

            // 檢查是否已滿
            const joinedCount = game.players.filter(p => p.joined).length;
            if (joinedCount >= game.totalPlayers) {
                showError('遊戲人數已滿');
                return;
            }

            // 檢查名字是否重複
            if (game.players.some(p => p.name === playerName && p.joined)) {
                showError('這個暱稱已經被使用了');
                return;
            }

            // 找到一個空位加入
            const emptySlot = game.players.find(p => !p.joined);
            if (!emptySlot) {
                showError('沒有空位了');
                return;
            }

            // 加入遊戲
            playerId = emptySlot.id;
            emptySlot.name = playerName;
            emptySlot.joined = true;
            emptySlot.joinTime = Date.now();

            // 儲存遊戲狀態
            localStorage.setItem(`game_${sessionId}`, JSON.stringify(game));

            // 儲存玩家資料
            localStorage.setItem(`player_${sessionId}`, JSON.stringify({
                playerId,
                playerName
            }));

            // 發送加入資料到 n8n
            sendToWebhook('player_joined', {
                is_eliminated: false,
                game_result: ''
            });

            // 顯示等待畫面
            showWaiting();

            // 開始檢查遊戲狀態
            startCheckingGame();
        }

        // 顯示等待畫面
        function showWaiting() {
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('waitingSection').style.display = 'block';
            document.getElementById('displayName').textContent = playerName;
        }

        // 開始檢查遊戲狀態
        function startCheckingGame() {
            if (checkInterval) clearInterval(checkInterval);
            checkInterval = setInterval(checkGameState, 1000);
        }

        // 檢查遊戲狀態
        function checkGameState() {
            const gameData = localStorage.getItem(`game_${sessionId}`);
            if (!gameData) {
                // 遊戲被刪除
                clearInterval(checkInterval);
                showError('遊戲已結束');
                setTimeout(() => location.reload(), 2000);
                return;
            }

            const game = JSON.parse(gameData);

            // 找到自己
            const me = game.players.find(p => p.id === playerId);
            if (!me) {
                clearInterval(checkInterval);
                showError('你已被移出遊戲');
                localStorage.removeItem(`player_${sessionId}`);
                setTimeout(() => location.reload(), 2000);
                return;
            }

            // 檢查遊戲是否開始
            if (game.started && !myRole) {
                myRole = me.role;
                myWord = me.word;
                showRole();
            }

            // 檢查遊戲是否結束
            if (game.ended) {
                clearInterval(checkInterval);
                showGameOver(game.winner, me);
            }
        }

        // 顯示角色
        function showRole() {
            document.getElementById('waitingSection').style.display = 'none';
            document.getElementById('roleSection').style.display = 'block';

            const badge = document.getElementById('roleBadge');
            const tips = document.getElementById('tipsContent');

            switch (myRole) {
                case 'civilian':
                    badge.textContent = '平民';
                    badge.className = 'role-badge role-civilian';
                    tips.innerHTML = '你是<strong>平民</strong>！找出拿到不同詞語的臥底，小心不要暴露太多細節。';
                    break;
                case 'undercover':
                    badge.textContent = '臥底';
                    badge.className = 'role-badge role-undercover';
                    tips.innerHTML = '你是<strong>臥底</strong>！你的詞語和大家不同，試著偽裝成平民，找出其他臥底。';
                    break;
                case 'blank':
                    badge.textContent = '白板';
                    badge.className = 'role-badge role-blank';
                    tips.innerHTML = '你是<strong>白板</strong>！你沒有詞語，要從大家的描述中猜出詞語是什麼，並偽裝成平民。';
                    break;
            }

            // 發送角色分配資料到 n8n
            sendToWebhook('role_assigned', {
                is_eliminated: false,
                game_result: ''
            });

            // 觸發震動（如果支援）
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
        }

        // 切換詞語顯示
        function toggleWord() {
            const wordDisplay = document.getElementById('wordDisplay');
            const revealBtn = document.getElementById('revealBtn');

            if (wordVisible) {
                wordDisplay.innerHTML = '<div class="word-hidden"><span>? ? ?</span></div>';
                revealBtn.textContent = '點擊查看詞語';
                wordVisible = false;
            } else {
                if (myRole === 'blank') {
                    wordDisplay.innerHTML = '<span style="font-size: 24px; color: rgba(255,255,255,0.5);">（你沒有詞語）</span>';
                } else {
                    wordDisplay.textContent = myWord;
                }
                revealBtn.textContent = '點擊隱藏詞語';
                wordVisible = true;

                // 5 秒後自動隱藏
                setTimeout(() => {
                    if (wordVisible) toggleWord();
                }, 5000);
            }
        }

        // 顯示遊戲結束
        function showGameOver(winner, me) {
            document.getElementById('roleSection').style.display = 'none';
            document.getElementById('waitingSection').style.display = 'none';
            document.getElementById('gameOverSection').style.display = 'block';

            const resultEl = document.getElementById('gameResult');
            const roleEl = document.getElementById('finalRole');

            const isCivilian = me.role === 'civilian';
            const civilianWon = winner === 'civilian';
            const won = (isCivilian && civilianWon) || (!isCivilian && !civilianWon);

            if (won) {
                resultEl.textContent = '恭喜獲勝！';
                resultEl.className = 'game-result result-win';
            } else {
                resultEl.textContent = '可惜落敗';
                resultEl.className = 'game-result result-lose';
            }

            let roleText = '';
            switch (me.role) {
                case 'civilian': roleText = '平民'; break;
                case 'undercover': roleText = '臥底'; break;
                case 'blank': roleText = '白板'; break;
            }

            roleEl.innerHTML = `你的身份是：<strong>${roleText}</strong><br>你的詞語是：<strong>${me.word || '（無）'}</strong>`;

            // 發送遊戲結果到 n8n
            sendToWebhook('game_ended', {
                is_eliminated: me.eliminated || false,
                game_result: won ? 'win' : 'lose'
            });
        }

        // 頁面載入
        window.onload = init;
    </script>
</body>
</html>
