<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>誰是臥底 - 結業回憶特別版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 30px 0;
        }
        h1 {
            font-size: 3em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1.3em;
            opacity: 0.9;
        }

        /* 設定面板 */
        .setup-panel {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .setup-panel h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            background: rgba(255,255,255,0.9);
            color: #333;
        }
        .word-pair {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .word-pair-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .word-pair input {
            flex: 1;
            margin-right: 10px;
        }
        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00c853, #00e676);
            color: #fff;
        }
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,200,83,0.4);
        }
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ff5252, #ff1744);
            color: #fff;
        }
        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        /* 遊戲面板 */
        .game-panel {
            display: none;
        }
        .game-panel.active {
            display: block;
        }
        .qr-section {
            text-align: center;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
        }
        .qr-container {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            display: inline-block;
            margin: 20px 0;
        }
        #qrcode {
            width: 300px;
            height: 300px;
        }
        .scan-instruction {
            font-size: 1.5em;
            margin-top: 20px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .player-count {
            font-size: 2em;
            margin: 20px 0;
        }
        .player-count span {
            color: #00e676;
            font-weight: bold;
        }

        /* 玩家列表 */
        .players-section {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .player-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s;
        }
        .player-card.eliminated {
            opacity: 0.4;
            text-decoration: line-through;
        }
        .player-card .player-number {
            font-size: 2em;
            font-weight: bold;
            color: #00e676;
        }
        .player-card .player-role {
            font-size: 0.8em;
            opacity: 0;
            margin-top: 5px;
        }
        .player-card.reveal .player-role {
            opacity: 1;
        }
        .player-card.civilian .player-role { color: #4fc3f7; }
        .player-card.undercover .player-role { color: #ff5252; }
        .player-card.blank .player-role { color: #ffd54f; }

        /* 規則面板 */
        .rules-section {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .rules-section h3 {
            margin-bottom: 15px;
            color: #ffd54f;
        }
        .rules-section ol {
            margin-left: 20px;
            line-height: 2;
        }

        /* 結果面板 */
        .result-panel {
            display: none;
            text-align: center;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 50px;
        }
        .result-panel.active {
            display: block;
        }
        .result-panel h2 {
            font-size: 3em;
            margin-bottom: 20px;
        }
        .word-reveal {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .word-box {
            background: rgba(255,255,255,0.2);
            padding: 30px 50px;
            border-radius: 15px;
        }
        .word-box h4 {
            font-size: 1em;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        .word-box .word {
            font-size: 2em;
            font-weight: bold;
        }

        /* 題目庫 */
        .word-bank {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .word-bank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .word-bank-item:hover {
            background: rgba(255,255,255,0.2);
        }
        .word-bank-item.selected {
            background: rgba(0,200,83,0.3);
            border: 2px solid #00c853;
        }

        /* 投票區 */
        .vote-section {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }
        .vote-section.active {
            display: block;
        }
        .round-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .round-number {
            font-size: 2em;
            color: #ffd54f;
        }

        footer {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }

        /* 動畫 */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: fall 3s linear forwards;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>誰是臥底</h1>
            <p class="subtitle">結業回憶特別版</p>
        </header>

        <!-- 設定面板 -->
        <div class="setup-panel" id="setupPanel">
            <h2>遊戲設定</h2>

            <div class="form-row">
                <div class="form-group">
                    <label>玩家人數</label>
                    <input type="number" id="playerCount" value="10" min="4" max="50">
                </div>
                <div class="form-group">
                    <label>臥底人數</label>
                    <input type="number" id="undercoverCount" value="2" min="1" max="5">
                </div>
                <div class="form-group">
                    <label>白板人數</label>
                    <input type="number" id="blankCount" value="0" min="0" max="2">
                </div>
            </div>

            <h3 style="margin: 20px 0 15px;">選擇題目</h3>
            <div class="word-bank" id="wordBank"></div>

            <div style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;">或自訂題目</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>平民詞 (題目A)</label>
                        <input type="text" id="wordA" placeholder="例：蘋果">
                    </div>
                    <div class="form-group">
                        <label>臥底詞 (題目B)</label>
                        <input type="text" id="wordB" placeholder="例：梨子">
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="startGame()">開始遊戲</button>
            </div>
        </div>

        <!-- 遊戲面板 -->
        <div class="game-panel" id="gamePanel">
            <!-- 網路設定提示 -->
            <div class="network-notice" id="networkNotice" style="background: rgba(255,193,7,0.2); border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin-bottom: 20px; display: none;">
                <p style="margin-bottom: 10px;"><strong>注意：</strong>目前使用 localhost，玩家手機無法連線！</p>
                <p style="margin-bottom: 10px;">請輸入電腦的區網 IP（在 CMD 輸入 ipconfig 查看）：</p>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="networkIP" placeholder="例如: 192.168.1.100"
                           style="flex:1; padding: 10px; border-radius: 5px; border: none; font-size: 16px;">
                    <button class="btn btn-secondary" onclick="updateNetworkIP()" style="padding: 10px 20px;">套用</button>
                </div>
            </div>

            <!-- QR Code 區 -->
            <div class="qr-section">
                <h2>掃描 QR Code 獲取你的身份</h2>
                <div class="qr-container">
                    <div id="qrcode"></div>
                </div>
                <div class="player-count">
                    已加入：<span id="joinedCount">0</span> / <span id="totalCount">0</span> 人
                </div>
                <p class="scan-instruction">請用手機掃描上方 QR Code</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="refreshQR()">重新產生 QR Code</button>
                    <button class="btn btn-primary" onclick="startRound()" id="startRoundBtn" disabled>全員到齊，開始遊戲！</button>
                </div>
            </div>

            <!-- 規則提醒 -->
            <div class="rules-section">
                <h3>遊戲規則</h3>
                <ol>
                    <li><strong>查看身份</strong>：每位玩家掃描 QR Code 查看自己的詞語</li>
                    <li><strong>輪流發言</strong>：每人用一句話描述自己的詞語（不能直接說出來！）</li>
                    <li><strong>投票淘汰</strong>：每輪結束後，投票選出最可疑的人</li>
                    <li><strong>勝利條件</strong>：
                        <ul>
                            <li>平民：找出所有臥底即獲勝</li>
                            <li>臥底：存活到最後或人數與平民相等即獲勝</li>
                            <li>白板：存活到最後並猜中平民詞即獲勝</li>
                        </ul>
                    </li>
                </ol>
            </div>

            <!-- 玩家列表 -->
            <div class="players-section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>玩家列表</h2>
                    <div>
                        <button class="btn btn-secondary btn-small" onclick="revealAll()">揭曉所有身份</button>
                        <button class="btn btn-danger btn-small" onclick="resetGame()">重新開始</button>
                    </div>
                </div>
                <div class="players-grid" id="playersGrid"></div>
            </div>

            <!-- 投票區 -->
            <div class="vote-section" id="voteSection">
                <div class="round-info">
                    <div class="round-number">第 <span id="roundNumber">1</span> 輪</div>
                    <p>討論結束後，點擊要淘汰的玩家</p>
                </div>
            </div>
        </div>

        <!-- 結果面板 -->
        <div class="result-panel" id="resultPanel">
            <h2 id="resultTitle">遊戲結束！</h2>
            <div class="word-reveal">
                <div class="word-box">
                    <h4>平民詞</h4>
                    <div class="word" id="revealWordA"></div>
                </div>
                <div class="word-box">
                    <h4>臥底詞</h4>
                    <div class="word" id="revealWordB"></div>
                </div>
            </div>
            <div id="winnerList" style="margin: 20px 0;"></div>
            <button class="btn btn-primary" onclick="resetGame()">再玩一局</button>
        </div>

        <footer>
            <p>結業快樂！願友誼長存！</p>
        </footer>
    </div>

    <script>
        // 題目庫 - 經典題目對
        const wordPairs = [
            { wordA: "蘋果", wordB: "梨子", category: "水果" },
            { wordA: "包子", wordB: "饅頭", category: "食物" },
            { wordA: "眼鏡", wordB: "墨鏡", category: "配件" },
            { wordA: "老師", wordB: "教授", category: "職業" },
            { wordA: "沙發", wordB: "椅子", category: "家具" },
            { wordA: "螞蟻", wordB: "蜜蜂", category: "昆蟲" },
            { wordA: "籃球", wordB: "排球", category: "運動" },
            { wordA: "可樂", wordB: "雪碧", category: "飲料" },
            { wordA: "微信", wordB: "LINE", category: "App" },
            { wordA: "漢堡", wordB: "三明治", category: "食物" },
            { wordA: "雨傘", wordB: "陽傘", category: "用品" },
            { wordA: "地鐵", wordB: "公車", category: "交通" },
            { wordA: "鋼琴", wordB: "電子琴", category: "樂器" },
            { wordA: "泡麵", wordB: "拉麵", category: "食物" },
            { wordA: "耳機", wordB: "喇叭", category: "3C" },
            { wordA: "冰淇淋", wordB: "冰棒", category: "甜點" },
            { wordA: "咖啡", wordB: "奶茶", category: "飲料" },
            { wordA: "貓", wordB: "狗", category: "寵物" },
            { wordA: "手機", wordB: "平板", category: "3C" },
            { wordA: "睡覺", wordB: "午休", category: "動作" },
            { wordA: "學校", wordB: "補習班", category: "場所" },
            { wordA: "考試", wordB: "測驗", category: "學校" },
            { wordA: "電影院", wordB: "Netflix", category: "娛樂" },
            { wordA: "書包", wordB: "手提袋", category: "包包" },
            { wordA: "牛排", wordB: "豬排", category: "食物" },
            { wordA: "薯條", wordB: "洋芋片", category: "零食" },
            { wordA: "蛋糕", wordB: "麵包", category: "烘焙" },
            { wordA: "西瓜", wordB: "哈密瓜", category: "水果" },
            { wordA: "警察", wordB: "保全", category: "職業" },
            { wordA: "游泳", wordB: "泡澡", category: "活動" },
            { wordA: "結業", wordB: "畢業", category: "學校" },
            { wordA: "同學", wordB: "朋友", category: "關係" },
        ];

        // 遊戲狀態
        let gameState = {
            players: [],
            wordA: "",
            wordB: "",
            totalPlayers: 0,
            undercoverCount: 0,
            blankCount: 0,
            currentRound: 1,
            gameStarted: false,
            joinedPlayers: 0,
            sessionId: ""
        };

        let selectedWordPair = null;

        // 初始化題目庫
        function initWordBank() {
            const bankEl = document.getElementById('wordBank');
            bankEl.innerHTML = wordPairs.map((pair, index) => `
                <div class="word-bank-item" onclick="selectWordPair(${index})" id="wordPair${index}">
                    <span><strong>${pair.wordA}</strong> vs <strong>${pair.wordB}</strong></span>
                    <span style="opacity:0.6">${pair.category}</span>
                </div>
            `).join('');
        }

        function selectWordPair(index) {
            // 取消之前的選擇
            document.querySelectorAll('.word-bank-item').forEach(el => el.classList.remove('selected'));
            // 選擇新的
            document.getElementById(`wordPair${index}`).classList.add('selected');
            selectedWordPair = wordPairs[index];
            document.getElementById('wordA').value = selectedWordPair.wordA;
            document.getElementById('wordB').value = selectedWordPair.wordB;
        }

        // 產生隨機 Session ID
        function generateSessionId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // 開始遊戲
        function startGame() {
            const totalPlayers = parseInt(document.getElementById('playerCount').value);
            const undercoverCount = parseInt(document.getElementById('undercoverCount').value);
            const blankCount = parseInt(document.getElementById('blankCount').value);
            const wordA = document.getElementById('wordA').value.trim();
            const wordB = document.getElementById('wordB').value.trim();

            // 驗證
            if (!wordA || !wordB) {
                alert('請選擇或輸入題目！');
                return;
            }
            if (undercoverCount + blankCount >= totalPlayers) {
                alert('臥底和白板人數不能超過總人數！');
                return;
            }

            // 設定遊戲狀態
            gameState.totalPlayers = totalPlayers;
            gameState.undercoverCount = undercoverCount;
            gameState.blankCount = blankCount;
            gameState.wordA = wordA;
            gameState.wordB = wordB;
            gameState.sessionId = generateSessionId();
            gameState.joinedPlayers = 0;
            gameState.currentRound = 1;
            gameState.gameStarted = true;

            // 分配角色
            assignRoles();

            // 更新 UI
            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('gamePanel').classList.add('active');
            document.getElementById('totalCount').textContent = totalPlayers;
            document.getElementById('joinedCount').textContent = '0';

            // 產生 QR Code
            generateQRCode();

            // 初始化玩家格子
            initPlayersGrid();

            // 儲存到 localStorage 讓玩家頁面可以讀取
            saveGameState();
        }

        // 分配角色
        function assignRoles() {
            gameState.players = [];

            // 建立角色池
            let roles = [];
            for (let i = 0; i < gameState.undercoverCount; i++) {
                roles.push('undercover');
            }
            for (let i = 0; i < gameState.blankCount; i++) {
                roles.push('blank');
            }
            while (roles.length < gameState.totalPlayers) {
                roles.push('civilian');
            }

            // 洗牌
            roles = shuffleArray(roles);

            // 建立玩家
            for (let i = 0; i < gameState.totalPlayers; i++) {
                gameState.players.push({
                    id: i + 1,
                    role: roles[i],
                    word: roles[i] === 'civilian' ? gameState.wordA :
                          roles[i] === 'undercover' ? gameState.wordB : '（你是白板，沒有詞語）',
                    eliminated: false,
                    joined: false
                });
            }
        }

        // 洗牌演算法
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // 自訂網路 IP
        let customNetworkIP = localStorage.getItem('customNetworkIP') || '';

        // 簡易 QR Code 產生器 (純 JavaScript)
        const QRCodeGenerator = (function() {
            // QR Code 資料編碼
            function getUTF8Bytes(str) {
                const bytes = [];
                for (let i = 0; i < str.length; i++) {
                    let c = str.charCodeAt(i);
                    if (c < 128) bytes.push(c);
                    else if (c < 2048) { bytes.push(192 | (c >> 6)); bytes.push(128 | (c & 63)); }
                    else { bytes.push(224 | (c >> 12)); bytes.push(128 | ((c >> 6) & 63)); bytes.push(128 | (c & 63)); }
                }
                return bytes;
            }

            // 使用 Google Chart API 產生 QR Code (備用方案)
            function generateViaAPI(text, size) {
                const img = document.createElement('img');
                img.src = `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chl=${encodeURIComponent(text)}&choe=UTF-8`;
                img.style.cssText = 'background: white; padding: 10px; border-radius: 10px;';
                img.alt = 'QR Code';
                return img;
            }

            // 使用 QR Server API (更可靠)
            function generateViaQRServer(text, size) {
                const img = document.createElement('img');
                img.src = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}`;
                img.style.cssText = 'background: white; padding: 10px; border-radius: 10px;';
                img.alt = 'QR Code';
                return img;
            }

            return {
                generate: function(text, size = 256) {
                    // 優先使用 QR Server API
                    return generateViaQRServer(text, size);
                }
            };
        })();

        // 產生 QR Code
        function generateQRCode() {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '<p style="color:#fff;">正在產生 QR Code...</p>';

            // 檢查是否為 localhost
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const networkNotice = document.getElementById('networkNotice');

            let baseUrl;
            // 取得基礎 URL
            const currentUrl = window.location.href;
            const basePath = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);

            if (isLocalhost && customNetworkIP) {
                // 使用自訂 IP
                baseUrl = `http://${customNetworkIP}:${window.location.port}/player.html`;
                networkNotice.style.display = 'none';
            } else if (isLocalhost) {
                // 顯示警告
                networkNotice.style.display = 'block';
                baseUrl = basePath + 'player.html';
            } else {
                // GitHub Pages 或其他網站
                networkNotice.style.display = 'none';
                baseUrl = basePath + 'player.html';
            }

            const gameUrl = `${baseUrl}?session=${gameState.sessionId}`;

            // 清空容器
            qrContainer.innerHTML = '';

            // 產生 QR Code 圖片
            const qrImg = QRCodeGenerator.generate(gameUrl, 280);
            qrImg.onload = function() {
                console.log('QR Code 載入成功');
            };
            qrImg.onerror = function() {
                qrContainer.innerHTML = `
                    <div style="background:#fff; padding:20px; border-radius:10px; color:#333;">
                        <p style="margin-bottom:10px;">QR Code 產生失敗</p>
                        <p style="font-size:12px;">請手動輸入網址加入遊戲</p>
                    </div>
                `;
            };
            qrContainer.appendChild(qrImg);

            // 同時顯示連結
            const linkDiv = document.createElement('div');
            linkDiv.style.cssText = 'margin-top:10px; font-size:0.9em; word-break:break-all;';
            linkDiv.innerHTML = `<a href="${gameUrl}" target="_blank" style="color:#fff;">${gameUrl}</a>`;
            qrContainer.appendChild(linkDiv);
        }

        // 更新網路 IP
        function updateNetworkIP() {
            const ipInput = document.getElementById('networkIP');
            const ip = ipInput.value.trim();
            if (ip) {
                customNetworkIP = ip;
                localStorage.setItem('customNetworkIP', ip);
                generateQRCode();
            }
        }

        function refreshQR() {
            gameState.sessionId = generateSessionId();
            generateQRCode();
            saveGameState();
        }

        // 初始化玩家格子
        function initPlayersGrid() {
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = gameState.players.map(player => `
                <div class="player-card ${player.role}" id="player${player.id}" onclick="toggleEliminate(${player.id})">
                    <div class="player-number">${player.id}</div>
                    <div class="player-status">${player.joined ? '✓ 已加入' : '等待中...'}</div>
                    <div class="player-role">${getRoleName(player.role)}</div>
                </div>
            `).join('');
        }

        function getRoleName(role) {
            switch(role) {
                case 'civilian': return '平民';
                case 'undercover': return '臥底';
                case 'blank': return '白板';
                default: return '';
            }
        }

        // 淘汰/取消淘汰玩家
        function toggleEliminate(playerId) {
            const player = gameState.players.find(p => p.id === playerId);
            if (player) {
                player.eliminated = !player.eliminated;
                const card = document.getElementById(`player${playerId}`);
                card.classList.toggle('eliminated');
                checkWinCondition();
            }
        }

        // 揭曉所有身份
        function revealAll() {
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.add('reveal');
            });
        }

        // 檢查勝利條件
        function checkWinCondition() {
            const alive = gameState.players.filter(p => !p.eliminated);
            const aliveUndercover = alive.filter(p => p.role === 'undercover').length;
            const aliveCivilian = alive.filter(p => p.role === 'civilian').length;

            if (aliveUndercover === 0) {
                endGame('civilian');
            } else if (aliveUndercover >= aliveCivilian) {
                endGame('undercover');
            }
        }

        // 結束遊戲
        function endGame(winner) {
            document.getElementById('gamePanel').classList.remove('active');
            document.getElementById('resultPanel').classList.add('active');

            document.getElementById('revealWordA').textContent = gameState.wordA;
            document.getElementById('revealWordB').textContent = gameState.wordB;

            if (winner === 'civilian') {
                document.getElementById('resultTitle').textContent = '平民獲勝！';
                document.getElementById('resultTitle').style.color = '#4fc3f7';
            } else {
                document.getElementById('resultTitle').textContent = '臥底獲勝！';
                document.getElementById('resultTitle').style.color = '#ff5252';
            }

            // 顯示角色列表
            const winnerList = document.getElementById('winnerList');
            winnerList.innerHTML = '<h3>角色揭曉</h3>' +
                gameState.players.map(p => `
                    <span style="margin:5px; padding:5px 15px; background:rgba(255,255,255,0.1); border-radius:20px; display:inline-block;">
                        ${p.id}號: <strong style="color:${p.role === 'undercover' ? '#ff5252' : p.role === 'blank' ? '#ffd54f' : '#4fc3f7'}">${getRoleName(p.role)}</strong>
                    </span>
                `).join('');

            // 慶祝動畫
            createConfetti();
        }

        // 撒花動畫
        function createConfetti() {
            const colors = ['#ff5252', '#ffd54f', '#4fc3f7', '#00e676', '#e040fb'];
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 30);
            }
        }

        // 重置遊戲
        function resetGame() {
            document.getElementById('setupPanel').style.display = 'block';
            document.getElementById('gamePanel').classList.remove('active');
            document.getElementById('resultPanel').classList.remove('active');
            localStorage.removeItem('whoIsUndercover');
        }

        // 儲存遊戲狀態
        function saveGameState() {
            localStorage.setItem('whoIsUndercover', JSON.stringify(gameState));
        }

        // 玩家加入更新 (由 player.html 觸發)
        function updatePlayerJoined() {
            const stored = localStorage.getItem('whoIsUndercover');
            if (stored) {
                const state = JSON.parse(stored);
                gameState = state;
                document.getElementById('joinedCount').textContent = state.joinedPlayers;

                // 更新玩家卡片
                state.players.forEach(player => {
                    const card = document.getElementById(`player${player.id}`);
                    if (card && player.joined) {
                        card.querySelector('.player-status').textContent = '✓ 已加入';
                        card.style.background = 'rgba(0,230,118,0.2)';
                    }
                });

                // 檢查是否全員到齊
                if (state.joinedPlayers >= state.totalPlayers) {
                    document.getElementById('startRoundBtn').disabled = false;
                }
            }
        }

        // 開始回合
        function startRound() {
            document.getElementById('voteSection').classList.add('active');
            document.getElementById('roundNumber').textContent = gameState.currentRound;
        }

        // 監聽 localStorage 變化
        window.addEventListener('storage', function(e) {
            if (e.key === 'whoIsUndercover') {
                updatePlayerJoined();
            }
        });

        // 定期檢查更新
        setInterval(updatePlayerJoined, 1000);

        // 初始化
        initWordBank();

        // 初始化網路 IP 輸入框
        if (customNetworkIP) {
            document.getElementById('networkIP').value = customNetworkIP;
        }
    </script>
</body>
</html>
