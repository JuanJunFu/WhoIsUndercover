<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>誰是臥底 - 結業回憶特別版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 30px 0;
        }
        h1 {
            font-size: 3em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1.3em;
            opacity: 0.9;
        }

        /* 面板樣式 */
        .panel {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .panel h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* 表單 */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 150px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        /* 按鈕 */
        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00c853, #00e676);
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 200, 83, 0.5);
        }
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.5);
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        /* QR Code 網格 */
        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .qr-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            color: #333;
        }
        .qr-card .player-num {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        .qr-card img {
            width: 150px;
            height: 150px;
            border-radius: 10px;
        }
        .qr-card .role-hint {
            font-size: 0.85em;
            color: #999;
            margin-top: 10px;
        }

        /* 詞語設定 */
        .word-section {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        .word-display {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .word-box {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .word-box.civilian { border-left: 5px solid #4CAF50; }
        .word-box.undercover { border-left: 5px solid #f44336; }

        /* 遊戲規則 */
        .rules {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        .rules h3 {
            margin-bottom: 15px;
        }
        .rules ol {
            padding-left: 25px;
        }
        .rules li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        /* 隱藏區塊 */
        .hidden {
            display: none !important;
        }

        /* 角色統計 */
        .role-stats {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .stat-badge {
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
        }
        .stat-civilian { background: #4CAF50; }
        .stat-undercover { background: #f44336; }
        .stat-blank { background: #9C27B0; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>誰是臥底</h1>
            <p class="subtitle">結業回憶特別版</p>
        </header>

        <!-- 設定面板 -->
        <div class="panel" id="setupPanel">
            <h2>遊戲設定</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>總人數</label>
                    <input type="number" id="totalPlayers" value="8" min="4" max="20">
                </div>
                <div class="form-group">
                    <label>臥底人數</label>
                    <input type="number" id="undercoverCount" value="2" min="1" max="5">
                </div>
                <div class="form-group">
                    <label>白板人數</label>
                    <input type="number" id="blankCount" value="0" min="0" max="2">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>詞語組合</label>
                    <select id="wordPair">
                        <option value="random">隨機選擇</option>
                    </select>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="startGame()">開始遊戲，產生 QR Code</button>
            </div>
        </div>

        <!-- 遊戲面板 -->
        <div class="panel hidden" id="gamePanel">
            <h2>請各位玩家掃描自己的 QR Code</h2>

            <div class="role-stats" id="roleStats"></div>

            <div class="word-section">
                <h3 style="text-align:center;">本局詞語（主持人專用，請勿讓玩家看到！）</h3>
                <div class="word-display" id="wordDisplay"></div>
            </div>

            <div class="qr-grid" id="qrGrid"></div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-secondary" onclick="resetGame()">重新開始</button>
                <button class="btn btn-primary" onclick="toggleWords()">顯示/隱藏詞語</button>
            </div>

            <div class="rules">
                <h3>遊戲流程</h3>
                <ol>
                    <li><strong>掃描身份</strong>：每位玩家掃描對應編號的 QR Code，查看自己的詞語</li>
                    <li><strong>輪流描述</strong>：從 1 號開始，每人用一句話描述自己的詞語（不能直接說！）</li>
                    <li><strong>投票淘汰</strong>：每輪結束後，大家投票選出最可疑的人淘汰</li>
                    <li><strong>揭曉身份</strong>：被淘汰的人公布身份，遊戲繼續直到分出勝負</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // 詞語庫
        const wordPairs = [
            ["蘋果", "梨子"], ["西瓜", "哈密瓜"], ["香蕉", "芭蕉"],
            ["牛奶", "豆漿"], ["咖啡", "奶茶"], ["可樂", "雪碧"],
            ["老師", "教授"], ["醫生", "護士"], ["警察", "保安"],
            ["貓", "狗"], ["老虎", "獅子"], ["熊貓", "北極熊"],
            ["汽車", "火車"], ["飛機", "直升機"], ["腳踏車", "機車"],
            ["手機", "平板"], ["電腦", "筆電"], ["電視", "投影機"],
            ["籃球", "排球"], ["足球", "橄欖球"], ["網球", "羽毛球"],
            ["書", "雜誌"], ["報紙", "傳單"], ["字典", "百科全書"],
            ["麵包", "蛋糕"], ["餅乾", "點心"], ["巧克力", "糖果"],
            ["沙發", "椅子"], ["床", "睡袋"], ["桌子", "茶几"],
            ["眼鏡", "墨鏡"], ["手錶", "手環"], ["項鍊", "手鏈"],
            ["結婚", "訂婚"]
        ];

        // 遊戲狀態
        let gameState = {
            players: [],
            civilianWord: '',
            undercoverWord: '',
            wordsHidden: true
        };

        // 初始化詞語選擇
        function initWordSelect() {
            const select = document.getElementById('wordPair');
            wordPairs.forEach((pair, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${pair[0]} / ${pair[1]}`;
                select.appendChild(option);
            });
        }

        // 洗牌
        function shuffle(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // 編碼資料為 Base64
        function encodeData(data) {
            return btoa(encodeURIComponent(JSON.stringify(data)));
        }

        // 產生 QR Code URL
        function getQRCodeUrl(text, size = 150) {
            return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}`;
        }

        // 開始遊戲
        function startGame() {
            const totalPlayers = parseInt(document.getElementById('totalPlayers').value);
            const undercoverCount = parseInt(document.getElementById('undercoverCount').value);
            const blankCount = parseInt(document.getElementById('blankCount').value);
            const wordPairIndex = document.getElementById('wordPair').value;

            // 驗證
            if (undercoverCount + blankCount >= totalPlayers) {
                alert('臥底和白板人數不能超過總人數！');
                return;
            }

            // 選擇詞語
            let pair;
            if (wordPairIndex === 'random') {
                pair = wordPairs[Math.floor(Math.random() * wordPairs.length)];
            } else {
                pair = wordPairs[parseInt(wordPairIndex)];
            }

            // 隨機決定哪個詞給平民
            if (Math.random() > 0.5) {
                pair = [pair[1], pair[0]];
            }
            gameState.civilianWord = pair[0];
            gameState.undercoverWord = pair[1];

            // 分配角色
            const roles = [];
            const civilianCount = totalPlayers - undercoverCount - blankCount;

            for (let i = 0; i < civilianCount; i++) roles.push('civilian');
            for (let i = 0; i < undercoverCount; i++) roles.push('undercover');
            for (let i = 0; i < blankCount; i++) roles.push('blank');

            const shuffledRoles = shuffle(roles);

            // 建立玩家資料
            gameState.players = shuffledRoles.map((role, index) => ({
                id: index + 1,
                role: role,
                word: role === 'civilian' ? gameState.civilianWord :
                      role === 'undercover' ? gameState.undercoverWord : ''
            }));

            // 顯示遊戲面板
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('gamePanel').classList.remove('hidden');

            // 顯示角色統計
            document.getElementById('roleStats').innerHTML = `
                <span class="stat-badge stat-civilian">平民 ${civilianCount} 人</span>
                <span class="stat-badge stat-undercover">臥底 ${undercoverCount} 人</span>
                ${blankCount > 0 ? `<span class="stat-badge stat-blank">白板 ${blankCount} 人</span>` : ''}
            `;

            // 顯示詞語（預設隱藏）
            updateWordDisplay();

            // 產生 QR Code
            generateQRCodes();
        }

        // 更新詞語顯示
        function updateWordDisplay() {
            const display = document.getElementById('wordDisplay');
            if (gameState.wordsHidden) {
                display.innerHTML = `
                    <div class="word-box">******</div>
                    <div class="word-box">******</div>
                `;
            } else {
                display.innerHTML = `
                    <div class="word-box civilian">平民：${gameState.civilianWord}</div>
                    <div class="word-box undercover">臥底：${gameState.undercoverWord}</div>
                `;
            }
        }

        // 切換詞語顯示
        function toggleWords() {
            gameState.wordsHidden = !gameState.wordsHidden;
            updateWordDisplay();
        }

        // 產生 QR Codes
        function generateQRCodes() {
            const grid = document.getElementById('qrGrid');
            const basePath = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);

            grid.innerHTML = gameState.players.map(player => {
                const data = encodeData({
                    id: player.id,
                    role: player.role,
                    word: player.word
                });
                const playerUrl = `${basePath}player.html?d=${data}`;
                const qrUrl = getQRCodeUrl(playerUrl);

                return `
                    <div class="qr-card">
                        <div class="player-num">玩家 ${player.id}</div>
                        <img src="${qrUrl}" alt="Player ${player.id} QR Code">
                        <div class="role-hint">掃描查看身份</div>
                    </div>
                `;
            }).join('');
        }

        // 重置遊戲
        function resetGame() {
            if (confirm('確定要重新開始嗎？')) {
                document.getElementById('setupPanel').classList.remove('hidden');
                document.getElementById('gamePanel').classList.add('hidden');
                gameState.wordsHidden = true;
            }
        }

        // 初始化
        initWordSelect();
    </script>
</body>
</html>
